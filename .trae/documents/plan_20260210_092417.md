# 修复评论发送失败与切换内置浏览器

## 问题分析
日志显示 `Timeout 30000ms exceeded`，定位失败的是发送按钮 (`.reply-box-send-btn, .send-text`)。虽然输入框已填入内容，但 Playwright 无法在超时时间内找到可点击的发送按钮。
**可能原因**：
1.  **DOM 结构变化**：新版 B 站评论组件的发送按钮 Class 可能已变更为 `.reply-btn` 或其他动态生成的类名。
2.  **Shadow DOM / iframe**：极少见，但部分组件可能被封装。
3.  **按钮未激活**：输入内容后，前端校验可能有延迟，导致按钮仍处于 disabled 状态。

## 解决方案

### 1. 切换为内置浏览器 (Trae 内置)
Trae 提供了 Web 预览功能，但 Playwright 默认启动的是系统级窗口。要实现“编辑器内及时 Review”，我们可以利用 Trae 的 `OpenPreview` 工具配合 Playwright 的 `headless` 模式（或通过 VNC/远程调试），但最直接的方式是**启动一个 HTTP 服务来托管 Playwright 的 Trace Viewer 或 Debug 模式**。
*   **修正理解**：用户希望“更改浏览器为编辑器内浏览器”，通常指的是让 Playwright 启动的浏览器窗口能被 Trae 捕获或直接在 Trae 的 Webview 中显示。但 Playwright 控制的是独立的 Chromium 实例。
*   **替代方案**：我们将继续使用 Playwright 的窗口（`headless=False`），但建议用户调整窗口位置。如果用户是指 Trae 的 **Preview** 面板，那通常用于 Web 开发预览。对于自动化脚本，最佳实践是保持 `headless=False` 并在桌面上观察，或者**使用 Playwright 的 Trace Viewer** 来回放。
*   **用户意图推测**：用户可能希望通过 `launch_persistent_context` 或调试端口连接，或者仅仅是希望不要全屏/后台运行。
*   **调整**：保持 `headless=False`，确保窗口可见。用户提到的“编辑器内浏览器”可能是指 Trae 的内置浏览器插件，但这通常不支持复杂的自动化控制。**我们将解释并优化窗口启动参数，使其更易观察。**

### 2. 修复发送按钮定位
我们将更新选择器策略，采用更鲁棒的定位方式：
*   **根据文本内容定位**：寻找包含“发布”或“发送”文本的按钮。
*   **父级定位**：先定位到评论框容器，再查找其内部的按钮。

### 执行计划
1.  **更新 `comment.py`**：
    *   增加发送按钮的备用选择器：`div.reply-box-send-btn`, `button.reply-box-send-btn`, 以及**文本定位** `page.get_by_text("发布")`。
    *   在点击前增加显式等待 `wait_for_selector`。
    *   增加 `force=True` 参数尝试强制点击。

2.  **配置调整**：
    *   无需代码变动，确认 `config.yaml` 中 `headless: false`。

### 待确认
*   “更改浏览器为编辑器内浏览器”：如果您是指 Trae 的内置预览窗口，由于 Playwright 需要控制原生浏览器 API，无法直接嵌入 Trae 的 Webview。我将确保弹出的 Chromium 窗口是独立的且可见的。

我将优先修复**发送按钮定位**问题，这是导致任务失败的直接原因。