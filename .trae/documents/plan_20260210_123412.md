# Bilibili 自动评论工具功能升级规划

根据您的需求，我将对 GUI 和底层逻辑进行全面升级，新增搜索筛选（时长、分区、日期）、排序控制以及视频选择策略。

## 🎯 升级目标
1.  **GUI 增强**: 在“运行参数”区域增加详细的筛选和策略配置项。
2.  **配置结构升级**: 更新 `config.yaml` 结构以支持新参数。
3.  **底层逻辑适配**: 修改 `core/search.py` 支持新的 URL 参数构造，修改 `main.py` 支持随机/顺序选择策略。

## 🛠️ 功能模块规划

### 1. GUI 界面升级 (`gui.py`)
在“运行参数”下方新增“搜索筛选与策略”分组：

*   **排序方式 (Combobox)**:
    *   选项: `综合排序` (totalrank), `最新发布` (pubdate), `最多播放` (click), `最多弹幕` (dm), `最多收藏` (stow)
*   **时长筛选 (Combobox)**:
    *   选项: `全部时长` (0), `10分钟以下` (1), `10-30分钟` (2), `30-60分钟` (3), `60分钟以上` (4)
*   **发布日期范围 (DateEntry x 2)**: *注：B 站 Web 端搜索并未直接提供日期范围 URL 参数，通常是“最近一天/一周/半年”的按钮。我们将模拟这些按钮对应的参数。*
    *   **发布时间 (Combobox)**: `不限` (0), `最近一天` (1), `最近一周` (2), `最近半年` (3) *（替代具体的 DatePicker，因为 B 站 API 通常只支持这些预设区间）*
*   **视频选择策略 (Combobox)**:
    *   选项: `顺序选择` (order) - 按搜索结果顺序, `随机选择` (random) - 从前 N 页结果中随机抽取
    *   *说明*: “随机选择”将改变 `main.py` 的处理逻辑，先抓取一批 URL，再从中随机 `sample`。

### 2. 配置文件升级 (`config.yaml`)
```yaml
search:
  # ... 原有字段 ...
  filter:
    order: "pubdate"
    duration: 0      # 新增
    tids: 0          # 分区ID (可选预留)
    time_range: 0    # 新增：0=不限, 1=1天, 2=1周, 3=半年
  strategy:
    selection: "order" # order/random
    random_pool_size: 20 # 随机模式下，先抓取多少个视频进池子
```

### 3. 底层逻辑适配

*   **`core/search.py`**:
    *   更新 `search_videos` 方法，接收 `duration`, `time_range` 等参数。
    *   构造 URL 时追加参数：`&duration={}`
    *   *注意*: `time_range` (最近一天等) 在 B 站搜索 URL 中通常体现为 `&tids_2=1` (分区) 或其它特定参数，需进一步确认映射关系。通常 B 站 Web 端参数为：
        *   `order`: 排序
        *   `duration`: 时长
        *   `tids_1`: 分区
        *   `pubtime_begin_s` / `pubtime_end_s`: 自定义日期范围（这个实现较复杂，建议优先实现“最近一天/一周”的预设值）
        *   *修正*: 根据您的截图，B 站使用的是“最近一天/一周”按钮。这对应 URL 参数通常不是标准的 key-value。
        *   *方案*: 既然 Playwright 是模拟浏览器，我们可以**直接点击这些按钮**，或者直接构造带参数的 URL。直接构造 URL 更稳定。
            *   `pubdate` (最新发布) 其实就是排序。
            *   筛选日期通常对应 URL 中的 `&range_from` 和 `&range_to` 或者特定的 `search_type`。
            *   *简化方案*: 使用 URL 参数 `&duration=X` (时长) 和 `&order=X` (排序) 是最稳妥的。至于“最近一天”，我们将在 URL 中添加 `&tids=0&category_id=&time_from=YYYYMMDD&time_to=YYYYMMDD` (如果支持) 或者使用 B 站特定的 `range` 参数。

*   **`main.py`**:
    *   实现 `selection` 策略逻辑。
    *   如果是 `random`，则在 `search_mgr.search_videos` 时请求更多数量（例如 20 个），然后 `random.sample` 取出 `max_videos_per_keyword` 个。

## 📅 执行计划
1.  **GUI 改造**: 修改 `gui.py`，增加上述 Combobox 组件。
2.  **配置适配**: 修改 `gui.py` 的 `save_config` 和 `load_config` 以支持新字段。
3.  **核心搜索升级**: 修改 `core/search.py`，支持 URL 参数拼接。
4.  **主逻辑升级**: 修改 `main.py` 实现随机选择策略。

准备就绪，确认后开始执行。